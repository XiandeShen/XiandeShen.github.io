<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcast Pro - Fixed</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        
        /* 布局锁定：确保 main 区域独立滚动 */
        html, body, #app { 
            height: 100dvh; margin: 0; overflow: hidden; background: #fff;
            position: relative;
        }
        
        /* 滚动区域修复：必须设置 -webkit-overflow-scrolling */
        .main-content { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 10;
        }
        .custom-scroll::-webkit-scrollbar { display: none; }

        /* 全屏播放层：优化层级和动画 */
        .fullscreen-overlay {
            position: fixed; 
            inset: 0; 
            z-index: 2000; /* 确保在最顶层 */
            background: #000;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex;
            flex-direction: column;
            pointer-events: none; /* 关闭时允许穿透 */
        }
        .fullscreen-overlay.open { 
            transform: translateY(0); 
            pointer-events: auto; /* 开启时捕捉事件 */
        }

        /* 底部播放栏：确保不遮挡滚动 */
        .mini-player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(80px + env(safe-area-inset-bottom));
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 进度条 */
        input[type="range"] {
            -webkit-appearance: none; background: rgba(0,0,0,0.05);
            height: 4px; border-radius: 2px; outline: none; width: 100%;
        }
        .fullscreen-overlay input[type="range"] {
            background: rgba(255,255,255,0.2);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            background: #6366f1; border-radius: 50%; border: 2px solid #fff;
        }
        .fullscreen-overlay input[type="range"]::-webkit-slider-thumb {
            background: #fff; border: none;
        }
    </style>
</head>
<body class="antialiased">

<div id="app" v-cloak class="flex flex-col h-full">
    
    <header class="px-6 pt-12 pb-4 flex justify-between items-end bg-white z-[50] flex-shrink-0">
        <div>
            <button v-if="view === 'show'" @click="view = 'library'" class="text-indigo-600 text-xs font-bold mb-1 flex items-center gap-1">
                <i class="fas fa-chevron-left"></i> 资料库
            </button>
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">
                {{ view === 'library' ? '资料库' : '详情' }}
            </h1>
        </div>
        <label class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600 cursor-pointer shadow-sm">
            <i class="fas fa-plus"></i>
            <input type="file" class="hidden" webkitdirectory @change="scanDirectory">
        </label>
    </header>

    <main class="main-content custom-scroll">
        <div v-if="view === 'library'" class="p-6 grid grid-cols-2 sm:grid-cols-3 gap-6">
            <div v-for="(podcast, idx) in library" :key="idx" @click="selectPodcast(idx)" class="cursor-pointer">
                <div class="aspect-square mb-3">
                    <img :src="podcast.image" class="w-full h-full object-cover rounded-[1.8rem] shadow-lg border border-gray-100">
                </div>
                <h3 class="text-sm font-bold text-gray-800 line-clamp-1 px-1">{{ podcast.title }}</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase mt-0.5 px-1">{{ podcast.author }}</p>
            </div>
            
            <div v-if="library.length === 0" class="col-span-full py-20 text-center text-slate-300">
                <p class="text-xs font-bold tracking-widest uppercase">导入目录开始收听</p>
            </div>
            <div class="h-32"></div>
        </div>

        <div v-if="view === 'show' && currentPodcast" class="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="px-6 pt-6 pb-8 flex flex-col items-center text-center">
                <img :src="currentPodcast.image" class="w-48 h-48 rounded-[2.5rem] shadow-2xl mb-6">
                <h2 class="text-xl font-bold text-gray-900 leading-tight">{{ currentPodcast.title }}</h2>
                <div class="mt-4 px-4 py-3 bg-slate-50 rounded-2xl text-left text-xs text-gray-500 leading-relaxed w-full">
                    {{ currentPodcast.description }}
                </div>
            </div>

            <div class="px-4 pb-40">
                <div v-for="ep in currentPodcast.episodes" :key="ep.url" @click="playTrack(ep)" 
                     class="flex items-center gap-4 p-4 rounded-2xl active:bg-slate-100 mb-1 border-b border-slate-50 last:border-0">
                    <div class="flex-1 min-w-0">
                        <p class="text-[9px] font-bold text-slate-400 mb-1 uppercase">{{ ep.date }}</p>
                        <h4 class="text-[14px] font-bold text-gray-800 line-clamp-2 leading-snug">{{ ep.title }}</h4>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500">
                        <i :class="['fas', playingTrack?.url === ep.url && isPlaying ? 'fa-pause' : 'fa-play text-[10px] ml-0.5']"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer v-if="playingTrack" class="mini-player-bar flex items-center px-5">
        <div @click="isFullscreen = true" class="flex items-center gap-3 min-w-0 flex-1 h-full">
            <img :src="playingTrack.image" class="w-12 h-12 rounded-xl object-cover shadow-md">
            <div class="min-w-0">
                <div class="text-xs font-black truncate text-gray-800">{{ playingTrack.title }}</div>
                <div class="text-[10px] font-bold text-indigo-500 uppercase">点击进入播放器</div>
            </div>
        </div>
        <button @click="togglePlay" class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition ml-4">
            <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play']"></i>
        </button>
    </footer>

    <div class="fullscreen-overlay" :class="{ 'open': isFullscreen }">
        <div class="absolute inset-0 -z-10">
            <img v-if="playingTrack" :src="playingTrack.image" class="w-full h-full object-cover opacity-30 blur-[100px] scale-150">
            <div class="absolute inset-0 bg-black/60"></div>
        </div>

        <div class="flex flex-col h-full px-8 pt-16 pb-12 text-white overflow-hidden">
            <button @click="isFullscreen = false" class="self-start w-10 h-10 flex items-center justify-center bg-white/10 rounded-full mb-4">
                <i class="fas fa-chevron-down"></i>
            </button>

            <div class="flex-1 flex flex-col items-center justify-center">
                <img v-if="playingTrack" :src="playingTrack.image" class="w-72 h-72 rounded-[2.5rem] shadow-2xl mb-12 border border-white/10">
                <div class="text-center w-full px-4">
                    <h2 class="text-xl font-bold mb-2 line-clamp-2">{{ playingTrack?.title }}</h2>
                    <p class="text-indigo-400 font-bold text-xs uppercase tracking-widest">{{ playingTrack?.channelName }}</p>
                </div>
            </div>

            <div class="w-full max-w-md mx-auto space-y-8">
                <div class="space-y-2">
                    <input type="range" :max="duration" :value="currentTime" @input="seek" class="w-full">
                    <div class="flex justify-between text-[10px] font-mono opacity-40">
                        <span>{{ formatTime(currentTime) }}</span>
                        <span>{{ formatTime(duration) }}</span>
                    </div>
                </div>

                <div class="flex items-center justify-around pb-10">
                    <button @click="skip(-15)" class="text-2xl opacity-60"><i class="fas fa-undo"></i></button>
                    <button @click="togglePlay" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-2xl active:scale-95 transition">
                        <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play text-2xl']"></i>
                    </button>
                    <button @click="skip(30)" class="text-2xl opacity-60"><i class="fas fa-redo"></i></button>
                </div>
            </div>
        </div>
    </div>

    <audio ref="player" v-if="playingTrack" :src="playingTrack.url" 
           @timeupdate="onUpdate" @loadedmetadata="onLoaded" 
           @playing="isPlaying = true" @pause="isPlaying = false"></audio>
</div>

<script>
const { createApp, ref, computed, nextTick } = Vue;

createApp({
    setup() {
        const view = ref('library');
        const library = ref([]);
        const activeIdx = ref(-1);
        const isPlaying = ref(false);
        const isFullscreen = ref(false);
        const playbackRate = ref(1);
        const currentTime = ref(0);
        const duration = ref(0);
        const playingTrack = ref(null);
        const player = ref(null);

        const currentPodcast = computed(() => activeIdx.value !== -1 ? library.value[activeIdx.value] : null);

        const parseRSS = async (file) => {
            try {
                const text = await file.text();
                const dom = new DOMParser().parseFromString(text, "text/xml");
                const channel = dom.querySelector("channel");
                const itunesImg = dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href");
                const finalImg = itunesImg || channel.querySelector("image url")?.textContent || "https://via.placeholder.com/300";
                
                const description = 
                    dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "summary")[0]?.textContent ||
                    channel.querySelector("description")?.textContent || "暂无简介";

                const episodes = Array.from(dom.querySelectorAll("item")).map(item => ({
                    title: item.querySelector("title")?.textContent,
                    url: item.querySelector("enclosure")?.getAttribute("url"),
                    date: new Date(item.querySelector("pubDate")?.textContent).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}),
                    image: item.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href") || finalImg
                })).filter(e => e.url);

                return { title: channel.querySelector("title")?.textContent, author: "播客频道", image: finalImg, description, episodes };
            } catch (e) { return null; }
        };

        const scanDirectory = async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.rss') || f.name.endsWith('.xml'));
            for (const f of files) {
                const p = await parseRSS(f);
                if (p) library.value.push(p);
            }
        };

        const selectPodcast = (idx) => {
            activeIdx.value = idx;
            view.value = 'show';
            nextTick(() => document.querySelector('.main-content').scrollTop = 0);
        };

        const playTrack = (ep) => {
            playingTrack.value = { ...ep, channelName: currentPodcast.value.title };
            nextTick(() => {
                if(player.value) {
                    player.value.load();
                    player.value.play();
                }
            });
        };

        const togglePlay = () => isPlaying.value ? player.value.pause() : player.value.play();
        const skip = (s) => player.value.currentTime += s;
        const seek = (e) => player.value.currentTime = e.target.value;

        return { 
            view, library, activeIdx, currentPodcast, playingTrack, isPlaying, isFullscreen,
            currentTime, duration, player,
            scanDirectory, selectPodcast, playTrack, togglePlay, skip, seek,
            onUpdate: () => currentTime.value = player.value?.currentTime || 0,
            onLoaded: () => duration.value = player.value?.duration || 0,
            formatTime: (s) => {
                const m = Math.floor(s/60), rs = Math.floor(s%60);
                return `${m}:${rs.toString().padStart(2,'0')}`;
            }
        };
    }
}).mount('#app');
</script>
</body>
</html>
