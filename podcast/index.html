<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcast Pro - Stage 3</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        /* 布局锁定：解决移动端工具栏遮挡 */
        html, body, #app { height: 100dvh; margin: 0; overflow: hidden; background: #fff; }
        .main-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { display: none; }

        /* 全屏播放器动画层 */
        .fullscreen-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: #000;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex; flex-direction: column;
        }
        .fullscreen-overlay.open { transform: translateY(0); }

        /* 进度条样式 (Audio CSS 基准) */
        input[type="range"] {
            -webkit-appearance: none; background: rgba(255,255,255,0.2);
            height: 4px; border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: #fff; border-radius: 50%; cursor: pointer;
        }

        /* 文本溢出控制 */
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="antialiased select-none">

<div id="app" v-cloak class="flex flex-col h-full">
    
    <header class="px-6 pt-12 pb-4 flex justify-between items-end bg-white/80 backdrop-blur-md z-50">
        <div>
            <button v-if="view === 'show'" @click="view = 'library'" class="text-indigo-600 text-xs font-bold mb-1 flex items-center gap-1">
                <i class="fas fa-chevron-left"></i> 资料库
            </button>
            <h1 class="text-3xl font-black text-gray-900 leading-none">
                {{ view === 'library' ? '资料库' : '节目详情' }}
            </h1>
        </div>
        <label class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-indigo-600 cursor-pointer active:scale-90 transition">
            <i class="fas fa-plus"></i>
            <input type="file" class="hidden" webkitdirectory @change="scanDirectory">
        </label>
    </header>

    <main class="main-content custom-scroll">
        <div v-if="view === 'library'" class="p-6 grid grid-cols-2 sm:grid-cols-3 gap-6">
            <div v-for="(podcast, idx) in library" :key="idx" @click="selectPodcast(idx)" class="cursor-pointer group">
                <div class="aspect-square mb-3 relative">
                    <img :src="podcast.image" class="w-full h-full object-cover rounded-[1.8rem] shadow-lg group-active:scale-95 transition-transform duration-300">
                </div>
                <h3 class="text-sm font-bold text-gray-800 line-clamp-1 px-1">{{ podcast.title }}</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase mt-0.5 px-1">{{ podcast.author }}</p>
            </div>
            <div v-if="library.length === 0" class="col-span-full py-20 text-center text-gray-300">
                <i class="fas fa-compact-disc text-5xl mb-4 animate-spin-slow"></i>
                <p class="text-xs font-bold uppercase tracking-widest">请点击右上角导入 RSS</p>
            </div>
            <div class="h-32 col-span-full"></div>
        </div>

        <div v-if="view === 'show' && currentPodcast" class="animate-in fade-in duration-500">
            <div class="px-6 pt-8 pb-8 flex flex-col items-center text-center">
                <img :src="currentPodcast.image" class="w-48 h-48 rounded-[2.5rem] shadow-2xl mb-6 border-4 border-white">
                <h2 class="text-xl font-black text-gray-900 leading-tight px-4">{{ currentPodcast.title }}</h2>
                <p class="text-indigo-600 font-bold text-xs mt-1 uppercase tracking-widest">{{ currentPodcast.author }}</p>
                
                <div class="mt-6 px-4 py-4 bg-gray-50 rounded-2xl border border-gray-100 w-full">
                    <p class="text-gray-500 text-xs leading-relaxed text-left" :class="{'line-clamp-3': !expandDesc}">
                        {{ currentPodcast.description }}
                    </p>
                    <button @click="expandDesc = !expandDesc" class="text-[10px] font-black text-indigo-500 mt-2 uppercase tracking-tighter">
                        {{ expandDesc ? '收起简介' : '查看完整简介' }}
                    </button>
                </div>
            </div>

            <div class="px-4 space-y-1 pb-40">
                <div v-for="ep in currentPodcast.episodes" :key="ep.url" @click="playTrack(ep)" 
                     class="flex items-center gap-4 p-4 rounded-2xl active:bg-gray-100 transition-all cursor-pointer">
                    <div class="flex-1 min-w-0">
                        <p class="text-[9px] font-bold text-gray-400 mb-1 uppercase">{{ ep.date }}</p>
                        <h4 class="text-[14px] font-bold text-gray-800 line-clamp-2 leading-snug">{{ ep.title }}</h4>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 flex-shrink-0">
                        <i class="fas fa-play text-[9px] ml-0.5"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer v-if="playingTrack" class="h-20 bg-white/90 backdrop-blur-xl border-t border-gray-100 px-5 pb-5 flex items-center justify-between z-[100] sticky bottom-0">
        <div class="flex items-center gap-3 min-w-0 flex-1" @click="isFullscreen = true">
            <img :src="playingTrack.image" class="w-12 h-12 rounded-xl object-cover shadow-md">
            <div class="min-w-0">
                <div class="text-xs font-black truncate text-gray-800">{{ playingTrack.title }}</div>
                <div class="text-[10px] font-bold text-indigo-500 uppercase">正在播放</div>
            </div>
        </div>
        <div class="flex items-center gap-5 ml-4">
            <button @click="togglePlay" class="w-12 h-12 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play', 'text-sm']"></i>
            </button>
        </div>
    </footer>

    <div class="fullscreen-overlay" :class="{ 'open': isFullscreen }">
        <div class="absolute inset-0 -z-10">
            <img v-if="playingTrack" :src="playingTrack.image" class="w-full h-full object-cover opacity-30 blur-[100px] scale-150">
            <div class="absolute inset-0 bg-black/60"></div>
        </div>

        <div class="flex flex-col h-full px-8 pt-16 pb-12 text-white">
            <button @click="isFullscreen = false" class="self-start w-10 h-10 flex items-center justify-center bg-white/10 rounded-full mb-8">
                <i class="fas fa-chevron-down text-sm"></i>
            </button>

            <div class="flex-1 flex flex-col items-center justify-center">
                <img v-if="playingTrack" :src="playingTrack.image" class="w-72 h-72 rounded-[2.5rem] shadow-2xl mb-12 border border-white/10 animate-in zoom-in-95 duration-500">
                <div class="w-full text-center px-4">
                    <h2 class="text-xl font-black mb-2 line-clamp-2 leading-tight">{{ playingTrack?.title }}</h2>
                    <p class="text-indigo-400 font-bold text-[10px] uppercase tracking-[0.2em]">{{ playingTrack?.channelName }}</p>
                </div>
            </div>

            <div class="w-full max-w-md mx-auto space-y-8">
                <div class="space-y-2">
                    <input type="range" :max="duration" :value="currentTime" @input="seek" class="w-full accent-white">
                    <div class="flex justify-between text-[10px] font-mono opacity-40">
                        <span>{{ formatTime(currentTime) }}</span>
                        <span>{{ formatTime(duration) }}</span>
                    </div>
                </div>

                <div class="flex items-center justify-between px-4 pb-8">
                    <button @click="changeSpeed" class="w-10 text-[10px] font-black border border-white/20 rounded-lg py-1 hover:bg-white/10">{{ playbackRate }}x</button>
                    <div class="flex items-center gap-10">
                        <button @click="skip(-15)" class="text-2xl opacity-60 active:opacity-100"><i class="fas fa-undo"></i></button>
                        <button @click="togglePlay" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition">
                            <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play', 'text-2xl']" :class="{'ml-1': !isPlaying}"></i>
                        </button>
                        <button @click="skip(30)" class="text-2xl opacity-60 active:opacity-100"><i class="fas fa-redo"></i></button>
                    </div>
                    <div class="w-10"></div>
                </div>
            </div>
        </div>
    </div>

    <audio ref="player" v-if="playingTrack" :src="playingTrack.url" 
           @timeupdate="onUpdate" @loadedmetadata="onLoaded" 
           @playing="isPlaying = true" @pause="isPlaying = false"></audio>
</div>

<script>
const { createApp, ref, computed, nextTick } = Vue;

createApp({
    setup() {
        const view = ref('library');
        const library = ref([]);
        const activeIdx = ref(-1);
        const isPlaying = ref(false);
        const isFullscreen = ref(false);
        const expandDesc = ref(false);
        const playbackRate = ref(1);
        const currentTime = ref(0);
        const duration = ref(0);
        const playingTrack = ref(null);
        const player = ref(null);

        const currentPodcast = computed(() => activeIdx.value !== -1 ? library.value[activeIdx.value] : null);

        // 增强版 RSS 解析（修复简介）
        const parseRSS = async (file) => {
            try {
                const text = await file.text();
                const dom = new DOMParser().parseFromString(text, "text/xml");
                const channel = dom.querySelector("channel");
                if (!channel) return null;

                // 1. 封面抓取
                const itunesImg = dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href");
                const standardImg = channel.querySelector("image url")?.textContent;
                const finalImg = itunesImg || standardImg || "https://via.placeholder.com/300";

                // 2. 简介抓取 (修复重点：多标签备份)
                const description = 
                    dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "summary")[0]?.textContent ||
                    dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "subtitle")[0]?.textContent ||
                    channel.querySelector("description")?.textContent || 
                    "该播客未提供简介。";

                const title = channel.querySelector("title")?.textContent || "未知节目";
                const author = dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "author")[0]?.textContent || "播客频道";

                const episodes = Array.from(dom.querySelectorAll("item")).map(item => {
                    const enc = item.querySelector("enclosure");
                    if (!enc) return null;
                    return {
                        title: item.querySelector("title")?.textContent,
                        url: enc.getAttribute("url"),
                        date: new Date(item.querySelector("pubDate")?.textContent).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}),
                        image: item.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href") || finalImg
                    };
                }).filter(i => i !== null);

                return { title, author, image: finalImg, description, episodes };
            } catch (e) { return null; }
        };

        const scanDirectory = async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.rss') || f.name.endsWith('.xml'));
            for (const file of files) {
                const pod = await parseRSS(file);
                if (pod) library.value.push(pod);
            }
            view.value = 'library';
        };

        const selectPodcast = (idx) => {
            activeIdx.value = idx;
            view.value = 'show';
            expandDesc.value = false;
            nextTick(() => document.querySelector('.main-content').scrollTop = 0);
        };

        const playTrack = (ep) => {
            playingTrack.value = { ...ep, channelName: currentPodcast.value.title };
            nextTick(() => {
                player.value.load();
                player.value.play();
            });
        };

        // 播放控制
        const togglePlay = () => isPlaying.value ? player.value.pause() : player.value.play();
        const skip = (s) => player.value.currentTime += s;
        const seek = (e) => player.value.currentTime = e.target.value;
        const changeSpeed = () => {
            const rates = [1, 1.25, 1.5, 2];
            playbackRate.value = rates[(rates.indexOf(playbackRate.value) + 1) % rates.length];
            player.value.playbackRate = playbackRate.value;
        };

        return { 
            view, library, activeIdx, currentPodcast, playingTrack, isPlaying, isFullscreen, expandDesc,
            playbackRate, currentTime, duration, player,
            scanDirectory, selectPodcast, playTrack, togglePlay, skip, seek, changeSpeed,
            onUpdate: () => currentTime.value = player.value?.currentTime || 0,
            onLoaded: () => duration.value = player.value?.duration || 0,
            formatTime: (s) => {
                const m = Math.floor(s/60), rs = Math.floor(s%60);
                return `${m}:${rs.toString().padStart(2,'0')}`;
            }
        };
    }
}).mount('#app');
</script>
</body>
</html>
