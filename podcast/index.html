<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcast Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        
        /* 1. 基础布局修复：锁定视口，允许 main 独立滚动 */
        html, body, #app { 
            height: 100dvh; margin: 0; overflow: hidden; background: #fff; 
        }
        .main-content { 
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            position: relative; z-index: 10;
        }
        .custom-scroll::-webkit-scrollbar { display: none; }

        /* 2. 全屏播放层：Apple 风格优化 */
        .fullscreen-overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: #000;
            transform: translateY(100%);
            visibility: hidden; /* 关闭时完全隐藏，防止阻挡点击 */
            pointer-events: none; /* 关闭时允许穿透 */
            transition: transform 0.6s cubic-bezier(0.32, 0.72, 0, 1), visibility 0.6s;
            display: flex; flex-direction: column;
        }
        .fullscreen-overlay.open { 
            transform: translateY(0); 
            visibility: visible; 
            pointer-events: auto; 
        }

        /* 3. 底部播放栏：解决遮挡问题 */
        .player-bottom-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        /* 4. 进度条 (Audio CSS 基准) */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: rgba(0,0,0,0.05); border-radius: 2px; outline: none;
        }
        .fullscreen-overlay input[type="range"] { background: rgba(255,255,255,0.2); }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px;
            border-radius: 50%; background: #6366f1; border: 2px solid #fff;
        }
        .fullscreen-overlay input[type="range"]::-webkit-slider-thumb { background: #fff; border: none; }

        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="antialiased select-none">

<div id="app" v-cloak class="flex flex-col h-full">
    
    <header class="px-6 pt-12 pb-4 flex justify-between items-end bg-white/80 backdrop-blur-md z-50 flex-shrink-0">
        <div>
            <button v-if="view === 'show'" @click="view = 'library'" class="text-indigo-600 text-xs font-bold mb-1 flex items-center gap-1">
                <i class="fas fa-chevron-left"></i> 资料库
            </button>
            <h1 class="text-3xl font-black text-gray-900 leading-none">
                {{ view === 'library' ? '资料库' : '节目详情' }}
            </h1>
        </div>
        <label class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-indigo-600 cursor-pointer active:scale-90 transition">
            <i class="fas fa-plus"></i>
            <input type="file" class="hidden" webkitdirectory @change="scanDirectory">
        </label>
    </header>

    <main class="main-content custom-scroll">
        <div v-if="view === 'library'" class="p-6 grid grid-cols-2 sm:grid-cols-3 gap-6">
            <div v-for="(podcast, idx) in library" :key="idx" @click="selectPodcast(idx)" class="cursor-pointer group">
                <div class="aspect-square mb-3 relative">
                    <img :src="podcast.image" class="w-full h-full object-cover rounded-[2rem] shadow-lg group-active:scale-95 transition-transform">
                </div>
                <h3 class="text-sm font-bold text-gray-800 line-clamp-1 px-1">{{ podcast.title }}</h3>
                <p class="text-[10px] text-gray-400 font-bold uppercase mt-0.5 px-1">{{ podcast.author }}</p>
            </div>
            <div v-if="library.length === 0" class="col-span-full py-20 text-center text-gray-300">
                <p class="text-xs font-bold uppercase tracking-widest">导入 RSS 目录开始收听</p>
            </div>
            <div class="h-32"></div>
        </div>

        <div v-if="view === 'show' && currentPodcast" class="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="px-6 pt-8 pb-8 flex flex-col items-center text-center">
                <img :src="currentPodcast.image" class="w-48 h-48 rounded-[2.5rem] shadow-2xl mb-6">
                <h2 class="text-xl font-black text-gray-900 leading-tight">{{ currentPodcast.title }}</h2>
                <p class="text-indigo-600 font-bold text-xs mt-1 uppercase tracking-widest">{{ currentPodcast.author }}</p>
                
                <div class="mt-6 px-4 py-4 bg-gray-50 rounded-2xl border border-gray-100 w-full text-left">
                    <p class="text-gray-500 text-xs leading-relaxed" :class="{'line-clamp-2': !expandDesc}">
                        {{ currentPodcast.description }}
                    </p>
                    <button @click="expandDesc = !expandDesc" class="text-[10px] font-black text-indigo-500 mt-2 uppercase">
                        {{ expandDesc ? '收起' : '查看完整简介' }}
                    </button>
                </div>
            </div>

            <div class="px-4 space-y-1 pb-40">
                <div v-for="ep in currentPodcast.episodes" :key="ep.url" @click="playTrack(ep)" 
                     class="flex items-center gap-4 p-4 rounded-2xl active:bg-gray-100 transition-all cursor-pointer">
                    <div class="flex-1 min-w-0">
                        <p class="text-[9px] font-bold text-gray-400 mb-1 uppercase">{{ ep.date }}</p>
                        <h4 class="text-[14px] font-bold text-gray-800 line-clamp-2 leading-snug">{{ ep.title }}</h4>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500">
                        <i :class="['fas', playingTrack?.url === ep.url && isPlaying ? 'fa-pause' : 'fa-play text-[9px] ml-0.5']"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer v-if="playingTrack" class="player-bottom-bar fixed bottom-0 left-0 right-0 flex items-center px-5 h-20">
        <div @click="isFullscreen = true" class="flex items-center gap-3 min-w-0 flex-1">
            <img :src="playingTrack.image" class="w-12 h-12 rounded-xl object-cover shadow-md">
            <div class="min-w-0">
                <div class="text-xs font-black truncate text-gray-800">{{ playingTrack.title }}</div>
                <div class="text-[10px] font-bold text-indigo-500 uppercase">正在播放</div>
            </div>
        </div>
        <button @click="togglePlay" class="w-12 h-12 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition ml-4">
            <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play']"></i>
        </button>
    </footer>

    <div class="fullscreen-overlay" :class="{ 'open': isFullscreen }">
        <div class="absolute inset-0 -z-10">
            <img v-if="playingTrack" :src="playingTrack.image" class="w-full h-full object-cover opacity-30 blur-[100px] scale-150">
            <div class="absolute inset-0 bg-black/70"></div>
        </div>

        <div class="flex flex-col h-full px-8 pt-12 pb-12 text-white overflow-hidden">
            <div class="flex justify-center items-center mb-10 flex-shrink-0">
                <button @click="isFullscreen = false" class="w-16 h-8 flex items-center justify-center">
                    <div class="w-10 h-1.5 bg-white/20 rounded-full"></div>
                </button>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
                <img v-if="playingTrack" :src="playingTrack.image" class="w-72 h-72 rounded-[2.5rem] shadow-2xl mb-12 border border-white/10">
                <div class="text-center w-full px-4">
                    <h2 class="text-xl font-bold mb-2 line-clamp-2 leading-tight">{{ playingTrack?.title }}</h2>
                    <p class="text-indigo-400 font-bold text-xs uppercase tracking-widest">{{ playingTrack?.channelName }}</p>
                </div>
            </div>

            <div class="w-full max-w-md mx-auto space-y-10">
                <div class="space-y-3">
                    <input type="range" :max="duration" :value="currentTime" @input="seek" class="w-full">
                    <div class="flex justify-between text-[10px] font-mono opacity-40">
                        <span>{{ formatTime(currentTime) }}</span>
                        <span>{{ formatTime(duration) }}</span>
                    </div>
                </div>

                <div class="flex items-center justify-around pb-10">
                    <button @click="skip(-15)" class="text-2xl opacity-60"><i class="fas fa-undo"></i></button>
                    <button @click="togglePlay" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-2xl active:scale-95 transition">
                        <i :class="['fas', isPlaying ? 'fa-pause' : 'fa-play text-2xl']"></i>
                    </button>
                    <button @click="skip(30)" class="text-2xl opacity-60"><i class="fas fa-redo"></i></button>
                </div>
            </div>
        </div>
    </div>

    <audio ref="player" v-if="playingTrack" :src="playingTrack.url" 
           @timeupdate="onUpdate" @loadedmetadata="onLoaded" 
           @playing="isPlaying = true" @pause="isPlaying = false"></audio>
</div>

<script>
const { createApp, ref, computed, nextTick } = Vue;

createApp({
    setup() {
        const view = ref('library');
        const library = ref([]);
        const activeIdx = ref(-1);
        const isPlaying = ref(false);
        const isFullscreen = ref(false);
        const expandDesc = ref(false);
        const currentTime = ref(0);
        const duration = ref(0);
        const playingTrack = ref(null);
        const player = ref(null);

        const currentPodcast = computed(() => activeIdx.value !== -1 ? library.value[activeIdx.value] : null);

        const parseRSS = async (file) => {
            try {
                const text = await file.text();
                const dom = new DOMParser().parseFromString(text, "text/xml");
                const channel = dom.querySelector("channel");
                
                // 简介多级抓取
                const description = 
                    dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "summary")[0]?.textContent ||
                    channel.querySelector("description")?.textContent || "暂无简介";

                const itunesImg = dom.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href");
                const finalImg = itunesImg || channel.querySelector("image url")?.textContent || "";

                const episodes = Array.from(dom.querySelectorAll("item")).map(item => ({
                    title: item.querySelector("title")?.textContent,
                    url: item.querySelector("enclosure")?.getAttribute("url"),
                    date: new Date(item.querySelector("pubDate")?.textContent).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}),
                    image: item.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href") || finalImg
                })).filter(e => e.url);

                return { title: channel.querySelector("title")?.textContent, author: "播客节目", image: finalImg, description, episodes };
            } catch (e) { return null; }
        };

        const scanDirectory = async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.rss') || f.name.endsWith('.xml'));
            for (const f of files) {
                const p = await parseRSS(f);
                if (p) library.value.push(p);
            }
        };

        const selectPodcast = (idx) => {
            activeIdx.value = idx;
            view.value = 'show';
            expandDesc.value = false;
            nextTick(() => document.querySelector('.main-content').scrollTop = 0);
        };

        const playTrack = (ep) => {
            playingTrack.value = { ...ep, channelName: currentPodcast.value.title };
            nextTick(() => {
                if(player.value) { player.value.load(); player.value.play(); }
            });
        };

        return { 
            view, library, activeIdx, currentPodcast, playingTrack, isPlaying, isFullscreen, expandDesc,
            currentTime, duration, player,
            scanDirectory, selectPodcast, playTrack,
            togglePlay: () => isPlaying.value ? player.value.pause() : player.value.play(),
            skip: (s) => player.value.currentTime += s,
            seek: (e) => player.value.currentTime = e.target.value,
            onUpdate: () => currentTime.value = player.value?.currentTime || 0,
            onLoaded: () => duration.value = player.value?.duration || 0,
            formatTime: (s) => {
                const m = Math.floor(s/60), rs = Math.floor(s%60);
                return `${m}:${rs.toString().padStart(2,'0')}`;
            }
        };
    }
}).mount('#app');
</script>
</body>
</html>
