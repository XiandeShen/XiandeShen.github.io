<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcasts</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        :root { --apple-blue: #007aff; }
        
        /* 1. 基础容器：锁定屏幕高度，严禁溢出 */
        body, html, #app {
            height: 100%; height: 100dvh;
            overflow: hidden; background: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .app-shell { display: flex; flex-direction: column; height: 100%; }

        /* 2. 滚动区：彻底解决遮挡的关键 */
        .content-scroller {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* 3. 底部播放器：物理占位，非悬浮 */
        .mini-player {
            flex-shrink: 0; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-top: 0.5px solid rgba(0,0,0,0.08);
            padding: 8px 16px calc(12px + env(safe-area-inset-bottom)) 16px;
        }

        /* 4. 进度条 */
        input[type="range"] {
            -webkit-appearance: none; background: transparent; width: 100%;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #666; margin-top: -4.5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* 5. 全屏适配层：使用 fixed 铺满 */
        .player-modal {
            position: fixed; inset: 0; z-index: 2000;
            background: #fff; transform: translateY(105%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .player-modal.active { transform: translateY(0); }

        /* 卡片阴影与交互 */
        .podcast-card { transition: transform 0.2s; }
        .podcast-card:active { transform: scale(0.96); }
        .episode-row:active { background: #f2f2f7; }

        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="app-shell">
    
    <header class="flex-shrink-0 px-6 pt-10 pb-4 bg-white/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex justify-between items-end">
            <div>
                <button v-if="view === 'detail'" @click="view = 'library'" class="text-indigo-600 font-bold text-sm mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-chevron-left"></i> 资料库
                </button>
                <h1 class="text-3xl font-black text-black tracking-tight">
                    {{ view === 'library' ? '资料库' : '节目详情' }}
                </h1>
            </div>
            <label class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600 cursor-pointer active:scale-90 transition">
                <i class="fa-solid fa-plus"></i>
                <input type="file" class="hidden" webkitdirectory @change="scanDirectory">
            </label>
        </div>
    </header>

    <main class="content-scroller custom-scroll">
        
        <div v-if="view === 'library'" class="p-5 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <div v-for="(item, idx) in library" :key="idx" @click="openPodcast(idx)" class="podcast-card cursor-pointer">
                <img :src="item.image" class="w-full aspect-square rounded-2xl shadow-lg object-cover border border-black/5 mb-3">
                <h3 class="text-sm font-bold text-slate-800 line-clamp-1">{{ item.name }}</h3>
                <p class="text-[11px] text-slate-400 font-bold uppercase truncate">{{ item.author || '未知作者' }}</p>
            </div>
            <div v-if="library.length === 0" class="col-span-full py-20 text-center text-slate-300">
                <i class="fa-solid fa-layer-group text-5xl mb-4"></i>
                <p class="text-sm">暂无播客，点击右上角导入目录</p>
            </div>
        </div>

        <div v-if="view === 'detail' && activeIdx !== -1" class="pb-10">
            <div class="px-6 flex flex-col items-center text-center mb-8">
                <img :src="library[activeIdx].image" class="w-48 h-48 rounded-3xl shadow-2xl object-cover mb-6 border-4 border-white">
                <h2 class="text-xl font-black text-slate-900 px-4">{{ library[activeIdx].name }}</h2>
                <p class="text-indigo-600 font-bold text-sm mt-1">{{ library[activeIdx].author }}</p>
            </div>

            <div class="px-4 space-y-1">
                <div v-for="ep in library[activeIdx].episodes" @click="playTrack(ep)" 
                     class="episode-row flex items-center gap-4 p-4 rounded-2xl transition-colors border-b border-slate-50">
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold text-slate-400 mb-1 uppercase">{{ ep.date }}</p>
                        <h4 class="text-[15px] font-bold text-slate-800 line-clamp-2" :class="playingTrack?.url === ep.url ? 'text-indigo-600' : ''">
                            {{ ep.title }}
                        </h4>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600">
                        <i class="fa-solid" :class="playingTrack?.url === ep.url && isPlaying ? 'fa-pause' : 'fa-play ml-0.5 text-xs'"></i>
                    </div>
                </div>
            </div>

            <footer class="mt-12 py-10 text-center px-10 border-t border-slate-50">
                <p class="text-[11px] font-black text-slate-300 tracking-widest uppercase mb-2">© 2026 AUDIO CSS 版权声明</p>
                <p class="text-[10px] text-slate-300 leading-relaxed">内容均来源于本地 RSS 订阅源，播放器不存储任何音频。适配所有移动端浏览器。</p>
            </footer>
        </div>
    </main>

    <footer v-if="playingTrack" class="mini-player" @click="isFullscreen = true">
        <div class="flex items-center gap-3">
            <img :src="playingTrack.image" class="w-12 h-12 rounded-xl object-cover shadow-sm border border-black/5">
            <div class="flex-1 min-w-0">
                <h4 class="text-sm font-bold text-black truncate">{{ playingTrack.title }}</h4>
                <p class="text-[11px] text-indigo-600 font-bold">正在播放 · {{ playingTrack.channelName }}</p>
            </div>
            <div class="flex items-center gap-6 px-2" @click.stop>
                <button @click="togglePlay" class="text-2xl text-black">
                    <i class="fa-solid" :class="isPlaying ? 'fa-pause' : 'fa-play'"></i>
                </button>
                <button @click="skip(30)" class="text-2xl text-black">
                    <i class="fa-solid fa-forward-step"></i>
                </button>
            </div>
        </div>
    </footer>

    <div class="player-modal" :class="{ active: isFullscreen }">
        <div class="flex-shrink-0 h-16 flex items-center justify-center" @click="isFullscreen = false">
            <div class="w-10 h-1.5 bg-slate-200 rounded-full"></div>
        </div>
        
        <div class="flex-1 flex flex-col px-8">
            <div class="flex-1 flex items-center justify-center py-4">
                <img :src="playingTrack?.image" class="w-full aspect-square max-w-[340px] rounded-[2.5rem] shadow-2xl object-cover border-4 border-slate-50">
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-black text-slate-900 leading-tight mb-2">{{ playingTrack?.title }}</h2>
                <p class="text-lg font-bold text-indigo-600">{{ playingTrack?.channelName }}</p>
            </div>

            <div class="space-y-2 mb-10">
                <input type="range" :max="duration" :value="currentTime" @input="seek" class="w-full">
                <div class="flex justify-between text-[11px] font-black text-slate-300 uppercase">
                    <span>{{ formatTime(currentTime) }}</span>
                    <span>-{{ formatTime(duration - currentTime) }}</span>
                </div>
            </div>

            <div class="flex justify-around items-center mb-12">
                <button @click="skip(-15)" class="text-3xl text-slate-900"><i class="fa-solid fa-rotate-left"></i></button>
                <button @click="togglePlay" class="w-24 h-24 rounded-full bg-slate-900 text-white flex items-center justify-center text-4xl shadow-xl active:scale-95 transition">
                    <i class="fa-solid" :class="isPlaying ? 'fa-pause' : 'fa-play ml-1'"></i>
                </button>
                <button @click="skip(30)" class="text-3xl text-slate-900"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

            <div class="flex justify-between items-center mb-8">
                <button @click="changeSpeed" class="px-5 py-2 bg-slate-100 rounded-full text-indigo-600 font-black text-xs">{{ playbackRate }}x 倍速</button>
                <button @click="isFullscreen = false" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>
        </div>
    </div>

    <audio ref="player" v-if="playingTrack" :src="playingTrack.url" @timeupdate="onUpdate" @loadedmetadata="onLoaded" @playing="isPlaying = true" @pause="isPlaying = false"></audio>
</div>

<script>
const { createApp, ref, nextTick } = Vue;
createApp({
    setup() {
        const player = ref(null);
        const library = ref([]);
        const activeIdx = ref(-1);
        const view = ref('library'); // 'library' 或 'detail'
        const isPlaying = ref(false);
        const isFullscreen = ref(false);
        const playbackRate = ref(1);
        const currentTime = ref(0);
        const duration = ref(0);
        const playingTrack = ref(null);

        const scanDirectory = async (e) => {
            const files = Array.from(e.target.files);
            const rssFiles = files.filter(f => f.name.endsWith('.rss') || f.name.endsWith('.xml'));
            const parser = new DOMParser();

            for (const f of rssFiles) {
                try {
                    const text = await f.text();
                    const xml = parser.parseFromString(text, "text/xml");
                    const itImg = xml.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href");
                    const stImg = xml.querySelector("image url")?.textContent;
                    const img = itImg || stImg || 'https://via.placeholder.com/300';
                    const author = xml.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "author")[0]?.textContent || "未知作者";
                    const title = xml.querySelector("channel > title")?.textContent || f.name;
                    
                    const episodes = Array.from(xml.querySelectorAll("item")).map(item => ({
                        title: item.querySelector("title")?.textContent,
                        url: item.getElementsByTagName("enclosure")[0]?.getAttribute("url"),
                        date: new Date(item.querySelector("pubDate")?.textContent).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}),
                        image: item.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href") || img,
                        channelName: title
                    })).filter(ep => ep.url);

                    if (episodes.length > 0) library.value.push({ name: title, author, image: img, episodes });
                } catch (err) { console.error("解析 RSS 出错", err); }
            }
            // 导入后保持在 library 视图
        };

        const openPodcast = (idx) => {
            activeIdx.value = idx;
            view.value = 'detail';
        };

        return { library, activeIdx, view, playingTrack, isPlaying, isFullscreen, playbackRate, currentTime, duration, scanDirectory, openPodcast, player,
            playTrack: (ep) => { playingTrack.value = ep; nextTick(() => { player.value.load(); player.value.play(); }); },
            formatTime: (s) => { if (isNaN(s)) return '0:00'; const m = Math.floor(s/60), rs = Math.floor(s%60); return `${m}:${rs.toString().padStart(2,'0')}`; },
            togglePlay: () => isPlaying.value ? player.value.pause() : player.value.play(),
            skip: (s) => player.value.currentTime += s,
            seek: (e) => player.value.currentTime = e.target.value,
            changeSpeed: () => { playbackRate.value = [1, 1.25, 1.5, 2][([1, 1.25, 1.5, 2].indexOf(playbackRate.value) + 1) % 4]; player.value.playbackRate = playbackRate.value; },
            onUpdate: () => currentTime.value = player.value ? player.value.currentTime : 0,
            onLoaded: () => duration.value = player.value ? player.value.duration : 0
        };
    }
}).mount('#app');
</script>
</body>
</html>
