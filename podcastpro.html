<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcasts</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        :root { --apple-blue: #007aff; --apple-bg: #ffffff; }
        
        body { background: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        /* 布局锁定：解决所有遮挡问题的关键 */
        .app-shell {
            display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden;
        }

        /* 1. 顶部内容区 */
        .content-scroller {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        /* 2. 模仿苹果底栏：Mini-Player */
        .mini-player {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            padding: 8px 16px calc(8px + env(safe-area-inset-bottom)) 16px;
            z-index: 50;
        }

        /* 3. 版权页脚：留白逻辑 */
        .apple-footer {
            padding: 40px 20px 60px 20px; text-align: center; color: #8e8e93; font-size: 11px;
        }

        /* 4. 进度条像素级重刻 */
        input[type="range"] {
            -webkit-appearance: none; background: transparent; height: 28px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #8e8e93; margin-top: -4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* 5. 全屏播放器模态框 */
        .player-modal {
            position: fixed; inset: 0; z-index: 1000; background: #fff;
            transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.32, 1, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .player-modal.active { transform: translateY(0); }

        .episode-row:active { background-color: #e5e5ea; transition: 0.1s; }
        .podcast-card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .custom-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

<div id="app" v-cloak class="app-shell">
    
    <nav class="flex-shrink-0 bg-white/80 backdrop-blur-lg px-5 py-4 flex justify-between items-end border-b border-black/5 z-40">
        <div>
            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Library</p>
            <h1 class="text-3xl font-extrabold text-black tracking-tight">播客</h1>
        </div>
        <label class="mb-1 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600 cursor-pointer">
            <i class="fa-solid fa-plus"></i>
            <input type="file" class="hidden" webkitdirectory @change="scanDirectory">
        </label>
    </nav>

    <main ref="scrollContainer" class="content-scroller custom-scroll">
        <div v-if="library.length === 0" class="h-full flex flex-col items-center justify-center p-12 text-center">
            <div class="w-20 h-20 text-slate-200 mb-4"><i class="fa-solid fa-broadcast-tower text-6xl"></i></div>
            <p class="text-slate-500 font-medium">添加包含 RSS 文件的目录<br>即可开始收听</p>
        </div>

        <template v-if="activeIdx !== -1">
            <div class="px-5 pt-8 pb-4">
                <div class="flex gap-5 mb-8">
                    <img :src="library[activeIdx].image" class="w-32 h-32 rounded-2xl podcast-card-shadow object-cover border border-black/5">
                    <div class="flex-1 pt-1">
                        <h2 class="text-xl font-bold text-black leading-tight line-clamp-2">{{ library[activeIdx].name }}</h2>
                        <p class="text-indigo-600 font-semibold text-sm mt-1">{{ library[activeIdx].author || '未知作者' }}</p>
                        <div class="mt-3 inline-flex items-center gap-1.5 px-3 py-1 bg-slate-200/50 rounded-full text-[10px] font-bold text-slate-600">
                            <i class="fa-solid fa-rss"></i> RSS FEED
                        </div>
                    </div>
                </div>

                <div class="space-y-1">
                    <div v-for="ep in library[activeIdx].episodes" @click="playTrack(ep)" 
                         class="episode-row flex items-center gap-4 py-3 border-b border-black/5 last:border-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-0.5">{{ ep.date }}</p>
                            <h3 class="text-[15px] font-bold text-slate-800 line-clamp-2 leading-snug" :class="playingTrack?.url === ep.url ? 'text-indigo-600' : ''">
                                {{ ep.title }}
                            </h3>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                            <i class="fa-solid" :class="playingTrack?.url === ep.url && isPlaying ? 'fa-pause' : 'fa-play text-xs ml-0.5'"></i>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="apple-footer">
                <div class="w-10 h-px bg-slate-200 mx-auto mb-6"></div>
                <p class="mb-2">© 2026 Apple 风格播客播放器</p>
                <p>基于本地扫描的 RSS 订阅源内容</p>
            </footer>
        </template>
    </main>

    <section v-if="playingTrack" class="mini-player" @click="isFullscreen = true">
        <div class="flex items-center gap-3">
            <img :src="playingTrack.image" class="w-12 h-12 rounded-lg object-cover shadow-sm">
            <div class="flex-1 min-w-0">
                <h4 class="text-sm font-bold text-black truncate">{{ playingTrack.title }}</h4>
                <p class="text-[11px] text-slate-500 font-medium">正在播放</p>
            </div>
            <div class="flex items-center gap-5 pr-1" @click.stop>
                <button @click="togglePlay" class="text-2xl text-black w-8">
                    <i class="fa-solid" :class="isPlaying ? 'fa-pause' : 'fa-play'"></i>
                </button>
                <button @click="skip(30)" class="text-2xl text-black">
                    <i class="fa-solid fa-forward-step"></i>
                </button>
            </div>
        </div>
    </section>

    <div class="player-modal" :class="{ 'active': isFullscreen }">
        <div class="flex-shrink-0 h-14 flex items-center justify-center">
            <div class="w-10 h-1.5 bg-slate-200 rounded-full" @click="isFullscreen = false"></div>
        </div>
        
        <div class="flex-1 flex flex-col px-8 pb-12">
            <div class="flex-1 flex items-center justify-center py-6">
                <img :src="playingTrack?.image" class="w-full aspect-square max-w-[320px] rounded-[2rem] shadow-2xl object-cover">
            </div>

            <div class="mb-10">
                <h2 class="text-2xl font-black text-black leading-tight mb-2">{{ playingTrack?.title }}</h2>
                <p class="text-lg font-bold text-indigo-600">{{ playingTrack?.channelName }}</p>
            </div>

            <div class="space-y-1 mb-10">
                <input type="range" :max="duration" :value="currentTime" @input="seek" class="w-full">
                <div class="flex justify-between text-[11px] font-bold text-slate-400">
                    <span>{{ formatTime(currentTime) }}</span>
                    <span>-{{ formatTime(duration - currentTime) }}</span>
                </div>
            </div>

            <div class="flex justify-around items-center mb-10">
                <button @click="skip(-15)" class="text-3xl text-black"><i class="fa-solid fa-undo"></i><span class="text-[10px] block font-black">15</span></button>
                <button @click="togglePlay" class="w-24 h-24 rounded-full bg-slate-50 flex items-center justify-center text-4xl text-black shadow-sm active:scale-95 transition">
                    <i class="fa-solid" :class="isPlaying ? 'fa-pause' : 'fa-play ml-1'"></i>
                </button>
                <button @click="skip(30)" class="text-3xl text-black"><i class="fa-solid fa-redo"></i><span class="text-[10px] block font-black">30</span></button>
            </div>

            <div class="flex justify-between items-center px-4">
                <button @click="changeSpeed" class="text-indigo-600 font-bold text-sm">{{ playbackRate }}x</button>
                <button @click="isFullscreen = false" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>
        </div>
    </div>

    <div v-if="!playingTrack" class="flex-shrink-0 h-[env(safe-area-inset-bottom)] bg-white"></div>

    <audio ref="player" v-if="playingTrack" :src="playingTrack.url" @timeupdate="onUpdate" @loadedmetadata="onLoaded" @playing="isPlaying = true" @pause="isPlaying = false"></audio>
</div>

<script>
const { createApp, ref, nextTick } = Vue;
createApp({
    setup() {
        const player = ref(null);
        const library = ref([]);
        const activeIdx = ref(-1);
        const isPlaying = ref(false);
        const isFullscreen = ref(false);
        const playbackRate = ref(1);
        const currentTime = ref(0);
        const duration = ref(0);
        const playingTrack = ref(null);

        const scanDirectory = async (e) => {
            const files = Array.from(e.target.files);
            const rssFiles = files.filter(f => f.name.endsWith('.rss') || f.name.endsWith('.xml'));
            const parser = new DOMParser();

            for (const f of rssFiles) {
                try {
                    const text = await f.text();
                    const xml = parser.parseFromString(text, "text/xml");
                    
                    // 获取封面 (适配 itunes:image 和 普通 image)
                    const itunesImg = xml.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href");
                    const standardImg = xml.querySelector("image url")?.textContent;
                    const img = itunesImg || standardImg;

                    // 获取作者
                    const author = xml.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "author")[0]?.textContent || xml.querySelector("channel > copyright")?.textContent;

                    const title = xml.querySelector("channel > title")?.textContent || f.name;
                    
                    const episodes = Array.from(xml.querySelectorAll("item")).map(item => ({
                        title: item.querySelector("title")?.textContent,
                        url: item.getElementsByTagName("enclosure")[0]?.getAttribute("url"),
                        date: new Date(item.querySelector("pubDate")?.textContent).toLocaleDateString('zh-CN', {month:'short', day:'numeric', year:'numeric'}),
                        image: item.getElementsByTagNameNS("http://www.itunes.com/dtds/podcast-1.0.dtd", "image")[0]?.getAttribute("href") || img,
                        channelName: title
                    })).filter(ep => ep.url);

                    if (episodes.length > 0) {
                        library.value.push({ name: title, author, image: img, episodes });
                    }
                } catch (err) { console.error("解析失败", err); }
            }
            if (library.value.length > 0 && activeIdx.value === -1) activeIdx.value = 0;
        };

        return { library, activeIdx, playingTrack, isPlaying, isFullscreen, playbackRate, currentTime, duration, scanDirectory, player,
            selectPodcast: (idx) => activeIdx.value = idx,
            playTrack: (ep) => { playingTrack.value = ep; nextTick(() => { player.value.load(); player.value.play(); }); },
            formatTime: (s) => { if (isNaN(s)) return '0:00'; const m = Math.floor(s/60), rs = Math.floor(s%60); return `${m}:${rs.toString().padStart(2,'0')}`; },
            togglePlay: () => isPlaying.value ? player.value.pause() : player.value.play(),
            skip: (s) => player.value.currentTime += s,
            seek: (e) => player.value.currentTime = e.target.value,
            changeSpeed: () => { playbackRate.value = [1, 1.25, 1.5, 2][([1, 1.25, 1.5, 2].indexOf(playbackRate.value) + 1) % 4]; player.value.playbackRate = playbackRate.value; },
            onUpdate: () => currentTime.value = player.value ? player.value.currentTime : 0,
            onLoaded: () => duration.value = player.value ? player.value.duration : 0
        };
    }
}).mount('#app');
</script>
</body>
</html>
